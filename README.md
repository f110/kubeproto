kubeproto
---

kubeproto is a plugin for Protocol Buffers to define k8s API.

The code generated by these plugins is incompatible with the code generated by code-generator.

**Status: Stabilizing API**

# Synopsis

## With Bazel

proto file

```protobuf
syntax = "proto3";
package example.apis.blogv1alpha1;
option go_package = "go.f110.dev/kubeproto/example/pkg/apis/blogv1alpha1";
option (dev.f110.kubeproto.k8s) = {
  domain: "f110.dev",
  sub_group: "blog",
  version: "v1alpha1",
};

import "kube.proto";

message Blog {
  BlogSpec   spec   = 1;
  BlogStatus status = 2;

  option (dev.f110.kubeproto.kind) = {
    scope: SCOPE_CLUSTER
  };
}
```

BUILD at pkg/apis/GROUP_AND_VERSION for generating deepcopy and register

```
load("@protobuf//bazel:proto_library.bzl", "proto_library")
load("//bazel:def.bzl", "kubeproto_go_api")

proto_library(
    name = "blog_proto",
    srcs = ["blog.proto"],
    deps = [
        "//:kubeproto",
    ],
    visibility = ["//visibility:public"],
)

kubeproto_go_api(
    name = "blog_proto_kubeproto",
    srcs = [":blog_proto"],
    importpath = "go.f110.dev/kubeproto/example/pkg/apis/blogv1alpha1",
)
```

BUILD file for generating the client

```
load("//bazel:def.bzl", "go_client")

go_client(
    name = "k8s",
    srcs = [
        "//example/pkg/apis/blogv1alpha1:blog_proto",
    ],
    importpath = "go.f110.dev/kubeproto/example/pkg/client",
    visibility = ["//visibility:public"],
)
```

BUILD file for generating for test

```
load("//bazel:def.bzl", "go_testing_client")

go_testing_client(
    name = "blog",
    srcs = [
        "//example/pkg/apis/blogv1alpha1:blog_proto",
    ],
    importpath = "go.f110.dev/kubeproto/example/pkg/client/testingclient",
    client = "//example/pkg/client:k8s",
    visibility = ["//visibility:public"],
)
```

BUILD file for generating CustomResourceDefinition

```
load("//bazel/crd:def.bzl", "crd_proto_manifest")

crd_proto_manifest(
    name = "crd",
    srcs = [
        "//example/pkg/apis/blogv1alpha1:blog_proto",
    ],
    visibility = ["//visibility:public"],
)
```

# How to use generated client

```go
cfg, err := rest.InClusterConfig()
if err != nil {
    return nil, err
}
apiClient, err := client.NewSet(cfg)
if err != nil {
    return nil, err
}

factory := client.NewInformerFactory(apiClient, client.NewInformerCache(), metav1.NamespaceAll, 30*time.Second)
blogInformers := client.NewBlogV1alpha1Informer(factory.Cache(), apiClient.BlogV1alpha1, metav1.NamespaceAll, 30*time.Second)
blogInformer := blogInformers.BlogInformer()
blogLister := blogInformers.BlogLister()
```

# Why use the extension number for internal?

These plugins are intended to use my projects.

If you want to use these plugins in your project, I would consider registering with Global Extension Registry.
Please feel free to file an issue! 

# Author

Fumihiro Ito
